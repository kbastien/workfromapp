!function(a,b){var c,d,e,f,g;a.Kiip||(f={version:"1.0f",request:b,busy:!1,requestQueue:[{events:[{id:"session_start",start:(new Date).toISOString()}]}],currentUnit:b,unitQueue:[],localWebIDKey:"kpwd",userData:null,app_key:null,frameTimeout:5e3,postData:function(a){return this.busy||!this.device_id?void this.requestQueue.push(a):(this.busy=!0,a=new e.Options(a),this.request||(window.XDomainRequest?(this.request=new window.XDomainRequest,this.request.onload=this._handleXDomainLoad,this.request.onerror=this._handleFailure,this.request.ontimeout=this._handleFailure):(this.request=new window.XMLHttpRequest,this.request.onreadystatechange=this._handleReadyStateChange)),this.request.open("POST",e.getOrigin()+e.API+"r="+e.now(),!0),this.request.setRequestHeader&&(this.request.setRequestHeader("Accept","application/json"),this.request.setRequestHeader("Content-Type","application/json"),this.request.setRequestHeader("X-Requested-With","XMLHttpRequest")),this.request._type=a.moment_id?"moment":"analytics",void this.request.send(JSON.stringify(a)))},_handleXDomainLoad:function(){f._handleSuccess(),f.busy=!1,f.nextMoment()},_handleReadyStateChange:function(){f.readyStateChange()},readyStateChange:function(){4===this.request.readyState&&("moment"===this.request._type&&(this.request.status>=200&&this.request.status<300||0===this.request.status?this._handleSuccess():this._handleFailure()),this.busy=!1,this.request._type=b,this.nextMoment())},_handleFailure:function(){f.instance.callback(null)},_handleSuccess:function(){var a;try{a=JSON.parse(this.request.responseText)}catch(b){a=null}a&&a.view?this.createUnit(a.view.modal):this._handleFailure()},_handleMessages:function(a){var b,c;b=a&&a.data?a.data:"",c=b.split("|"),f.parseFrameCommand(c[0],c[1])},_handleDeviceIDFail:function(){f.parseFrameCommand("webid","blocked;web-noid")},_handleUnitFail:function(){f.parseFrameCommand("destroy"),f.instance.callback(null)},parseFrameCommand:function(a,c){var d=this.currentUnit;clearTimeout(this._iframeTimeout),"webid"===a&&(this.busy=!1,this.validateWebID(c),this.nextMoment()),"ready"===a&&d&&this.instance.callback(d),"destroy"===a&&d&&d.destroy(),d=b},validateWebID:function(a){a&&a.match(/^blocked;/)&&(a=a.split(";")[1],a=this.getLocalWebID(a)),this.device_id=a,this.webIDFrame.parentNode.removeChild(this.webIDFrame),this.webIDFrame=b},getLocalWebID:function(a){var b,c=window.localStorage&&window.localStorage.getItem?window.localStorage:null;return c&&(b=c.getItem(this.localWebIDKey)),b||(b=this.getCookie(this.localWebIDKey)),b||(b=a),c&&c.setItem(this.localWebIDKey,b),this.setCookie(this.localWebIDKey,b,1/0,"/",window.location.hostname,!1),b},createUnit:function(a){return this.currentUnit?void this.unitQueue.push(a):void(this.currentUnit=new d(a.body_url))},nextUnit:function(){var a=this.unitQueue.shift();this.currentUnit=b,a&&this.createUnit(a)},nextMoment:function(){this.requestQueue.length&&!this.busy&&this.postData(this.requestQueue.shift())},getDeviceID:function(){var a;if(!(this.busy||this.device_id||e.isBadIE)){if(!window.document.body)return void window.document.addEventListener("DOMContentLoaded",this.getDeviceID.bind(this),!1);window.addEventListener("message",f._handleMessages,!1),this.busy=!0,a=e.getOrigin()+"/webid/",a+="?"+encodeURIComponent(e.protocol+"://"+window.location.hostname+(window.location.port?":"+window.location.port:"")),this.webIDFrame=document.createElement("iframe"),this.webIDFrame.setAttribute("frameborder","0"),this.webIDFrame.setAttribute("src",a),this.webIDFrame.style.position="absolute",this.webIDFrame.style.width=0,this.webIDFrame.style.height=0,document.body.appendChild(this.webIDFrame),this._iframeTimeout=setTimeout(this._handleDeviceIDFail,this.frameTimeout)}},getCookie:function(a){return decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null},setCookie:function(a,b,c,d,e,f){if(!a||/^(?:expires|max\-age|path|domain|secure)$/i.test(a))return!1;var g="";if(c)switch(c.constructor){case Number:g=1/0===c?"; expires=Fri, 31 Dec 9999 23:59:59 GMT":"; max-age="+c;break;case String:g="; expires="+c;break;case Date:g="; expires="+c.toUTCString()}return document.cookie=encodeURIComponent(a)+"="+encodeURIComponent(b)+g+(e?"; domain="+e:"")+(d?"; path="+d:"")+(f?"; secure":""),!0}},e={isBadIE:!window.document.addEventListener,protocol:"file:"===window.location.protocol?"http":window.location.protocol.replace(":",""),origin:"://api.kiip.me",getOrigin:function(){return this.protocol+this.origin},API:"/2.0/web/moment/?",Options:function(a){var b={};return f.testMode&&(b.test=!0),f.web_user_id&&(b.web_user_id=f.web_user_id),"[object Object]"===e.typeOf(a)&&e.merge(b,a),b.app_key=f.app_key,b.user_data=f.userData,b.protocol=e.protocol,b.sdk_version="1.0",b.device_id=f.device_id,b},toQueryString:function(a){var b,c,d,e=[];for(d in a)b=a[d],c=d+"="+encodeURIComponent(b),b&&e.push(c);return e.join("&")},merge:function(a,b){var c;for(c in b)"[object Function]"!==e.typeOf(b[c])&&b[c]&&(a[c]=b[c]);return a},now:function(){return+new Date},typeOf:function(a){return Object.prototype.toString.call(a)},uniqueID:function(){return g||(g=e.now()),(g++).toString(36)}},c=function(a,b){if(f.instance&&a===f.app_key)return f.instance;if(f.instance)throw new Error("Kiip Error: Only one Kiip instance is allowed per page");if(!a)throw new Error("Kiip Error: You must supply an app key");(!window.JSON||e.isBadIE)&&(f.disabled=!0),f.app_key=a,"[object Function]"===e.typeOf(b)&&(this.callback=b),f.instance=this},c.prototype.setEmail=function(a){return f.email=a,this},c.prototype.setUserId=function(a){return("[object String]"===e.typeOf(a)||"[object Number]"===e.typeOf(a))&&(f.web_user_id=a+""),this},c.prototype.setContainer=function(a){return f.container="[object String]"===e.typeOf(a)?document.getElementById(a):a,this},c.prototype.setUserData=function(a){return"[object Object]"!==e.typeOf(a)?this:(f.userData||(f.userData={}),e.merge(f.userData,a),this)},c.prototype.setTestMode=function(){return f.testMode=!0,this},c.prototype.postMoment=function(a){return!a||f.disabled?(this.callback(null),this):(f.postData({moment_id:a}),this)},c.prototype.callback=function(a){a&&a.show&&a.show()},c.prototype.unload=function(){return f.email=b,f.container=b,f.currentUnit&&f.currentUnit.destroy(),f.request&&f.request.abort(),window.removeEventListener?window.removeEventListener("message",f._handleMessages,!1):window.detachEvent("onmessage",f._handleMessages),f.instance=null,b},c.version=f.version,d=function(a){var b,c,d;this.id=e.uniqueID(),a+="&domain="+encodeURIComponent(e.protocol+"://"+window.location.hostname+(window.location.port?":"+window.location.port:"")),a+="&frame_id="+this.id,a+="&overlay="+(f.container?"false":"true"),b=document.createElement("iframe"),b.setAttribute("frameborder","0"),b.setAttribute("src",a),b.style.zIndex="2147483647",b.style.width="100%",b.style.height="100%",b.style.minWidth="320px",b.style.minHeight="330px",f.container?(b.style.position="relative",f.container.appendChild(b)):(b.style.position="fixed",b.style.top="-999999px",b.style.left="-999999px",document.body.appendChild(b)),this.setID=function(a){return b.id=a,this},this.show=function(a){return d?this:(d=!0,b.style.top="0px",b.style.left="0px","[object Function]"===e.typeOf(a)&&(c=a),b.contentWindow.postMessage("show",e.getOrigin()),f.email&&b.contentWindow.postMessage("email="+f.email,e.getOrigin()),this)},this.destroy=function(){return d?(d=!1,b.parentNode.removeChild(b),c&&c(),f.nextUnit(),this):this},f._iframeTimeout=setTimeout(f._handleUnitFail,f.frameTimeout)},f.getDeviceID(),window.Kiip=c)}(window);